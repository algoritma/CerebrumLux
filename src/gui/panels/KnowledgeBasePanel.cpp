#include "KnowledgeBasePanel.h"
#include <QVBoxLayout>
#include <QHBoxLayout>
#include <QMessageBox>
#include <QHeaderView>
#include <QRegularExpression>
#include <QLabel>
#include <QSet> // uniqueTopics i√ßin
#include "../../core/logger.h"
#include "../../core/utils.h"

namespace CerebrumLux {

KnowledgeBasePanel::KnowledgeBasePanel(LearningModule& learningModuleRef, QWidget *parent)
    : QWidget(parent),
      learningModule(learningModuleRef)
{
    setupUi();
    LOG_DEFAULT(LogLevel::INFO, "KnowledgeBasePanel: Initialized.");
    updateKnowledgeBaseContent(); // Ba≈ülangƒ±√ßta i√ßeriƒüi y√ºkle
}

KnowledgeBasePanel::~KnowledgeBasePanel() {
    LOG_DEFAULT(LogLevel::INFO, "KnowledgeBasePanel: Destructor called.");
}

void KnowledgeBasePanel::setupUi() {
    QVBoxLayout *mainLayout = new QVBoxLayout(this);
    mainLayout->setContentsMargins(0, 0, 0, 0);

    mainLayout->addWidget(new QLabel("KnowledgeBase ƒ∞√ßeriƒüi:", this));

    // üîç Arama kutusu
    QHBoxLayout *searchLayout = new QHBoxLayout();
    searchLineEdit = new QLineEdit(this);
    searchLineEdit->setPlaceholderText("Kaps√ºllerde ara (ID, Konu, √ñzet)...");
    connect(searchLineEdit, &QLineEdit::textChanged, this, &CerebrumLux::KnowledgeBasePanel::onSearchTextChanged);

    clearSearchButton = new QPushButton("Temizle", this);
    connect(clearSearchButton, &QPushButton::clicked, this, &CerebrumLux::KnowledgeBasePanel::onClearSearchClicked);

    searchLayout->addWidget(searchLineEdit);
    searchLayout->addWidget(clearSearchButton);
    mainLayout->addLayout(searchLayout);

    // üìÇ Filtreleme Kontrolleri
    QHBoxLayout *filterLayout = new QHBoxLayout();

    filterLayout->addWidget(new QLabel("Konu:", this));
    topicFilterComboBox = new QComboBox(this);
    topicFilterComboBox->addItem("T√ºm√º");
    connect(topicFilterComboBox, &QComboBox::currentTextChanged, this, &CerebrumLux::KnowledgeBasePanel::onTopicFilterChanged);
    filterLayout->addWidget(topicFilterComboBox);

    // ‚úÖ √ñzel Filtre: Sadece Code Development gibi
    filterLayout->addWidget(new QLabel("√ñzel Filtre:", this));
    specialFilterComboBox = new QComboBox(this);
    specialFilterComboBox->addItem("T√ºm√º");
    specialFilterComboBox->addItem("Sadece Code Development");
    connect(specialFilterComboBox, &QComboBox::currentTextChanged, this, &CerebrumLux::KnowledgeBasePanel::onSpecialFilterChanged);
    filterLayout->addWidget(specialFilterComboBox);

    filterLayout->addWidget(new QLabel("Ba≈ülangƒ±√ß Tarihi:", this));
    startDateEdit = new QDateEdit(QDate(2000, 1, 1), this);
    startDateEdit->setCalendarPopup(true);
    connect(startDateEdit, &QDateEdit::dateChanged, this, &CerebrumLux::KnowledgeBasePanel::onStartDateChanged);
    filterLayout->addWidget(startDateEdit);

    filterLayout->addWidget(new QLabel("Biti≈ü Tarihi:", this));
    endDateEdit = new QDateEdit(QDate::currentDate().addYears(1), this); // Bug√ºn + 1 yƒ±l
    endDateEdit->setCalendarPopup(true);
    connect(endDateEdit, &QDateEdit::dateChanged, this, &CerebrumLux::KnowledgeBasePanel::onEndDateChanged);
    filterLayout->addWidget(endDateEdit);

    filterLayout->addStretch();
    mainLayout->addLayout(filterLayout);

    // üîó Splitter: Liste + Detay
    QSplitter *splitter = new QSplitter(Qt::Vertical, this); // Dikey splitter daha kullanƒ±≈ülƒ± olabilir
    capsuleListWidget = new QListWidget(this);
    capsuleListWidget->setSelectionMode(QAbstractItemView::SingleSelection);
    connect(capsuleListWidget, &QListWidget::currentItemChanged, this, &CerebrumLux::KnowledgeBasePanel::onSelectedCapsuleChanged);
    splitter->addWidget(capsuleListWidget);

    capsuleDetailDisplay = new QTextEdit(this);
    capsuleDetailDisplay->setReadOnly(true);
    splitter->addWidget(capsuleDetailDisplay);

    // üëçüëé Geri bildirim butonlarƒ±
    QHBoxLayout *feedbackLayout = new QHBoxLayout();
    acceptSuggestionButton = new QPushButton("√ñneriyi Kabul Et", this);
    rejectSuggestionButton = new QPushButton("√ñneriyi Reddet", this);
    feedbackLayout->addWidget(acceptSuggestionButton);
    feedbackLayout->addWidget(rejectSuggestionButton);
    mainLayout->addLayout(feedbackLayout);

    connect(acceptSuggestionButton, &QPushButton::clicked, this, &CerebrumLux::KnowledgeBasePanel::onAcceptSuggestionClicked);
    connect(rejectSuggestionButton, &QPushButton::clicked, this, &CerebrumLux::KnowledgeBasePanel::onRejectSuggestionClicked);
    updateSuggestionFeedbackButtons(""); // Ba≈ülangƒ±√ßta butonlarƒ± pasif yap

    mainLayout->addWidget(splitter);
    mainLayout->addStretch(1);
    setLayout(mainLayout);
}
// 
void KnowledgeBasePanel::updateKnowledgeBaseContent() {
    LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: KnowledgeBase i√ßeriƒüi g√ºncelleniyor.");

    QString selectedCapsuleId;
    if (capsuleListWidget->currentItem()) {
        selectedCapsuleId = capsuleListWidget->currentItem()->data(Qt::UserRole).toString();
        LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Mevcut secili kapsul ID: " << selectedCapsuleId.toStdString());
    } // else { selectedCapsuleId kalƒ±r}

    currentDisplayedCapsules = learningModule.getKnowledgeBase().get_all_capsules(); // T√ºm kaps√ºlleri al (Kaps√ºl sayisi logu kaldirildi, c√ºnk√º amacina ulasti)

    // Mevcut se√ßili konuyu kaydet
    QString currentTopicSelection = topicFilterComboBox->currentText();
    LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Mevcut secili konu: " << currentTopicSelection.toStdString());

    // Konu filtrelerini yeniden doldur
    QSet<QString> uniqueTopics;
    for (const auto& capsule : currentDisplayedCapsules) {
        uniqueTopics.insert(QString::fromStdString(capsule.topic));
    }
    topicFilterComboBox->blockSignals(true); // Sinyalleri ge√ßici olarak engelle
    topicFilterComboBox->clear();
    topicFilterComboBox->addItem("T√ºm√º");
    for (const QString& topic : uniqueTopics) {
        topicFilterComboBox->addItem(topic);
    }

    // √ñnceden se√ßili konuyu geri y√ºkle, yoksa "T√ºm√º"n√º se√ß
    int index = topicFilterComboBox->findText(currentTopicSelection);
    if (index != -1) {
        topicFilterComboBox->setCurrentIndex(index);
        LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Onceki konu secimi geri yuklendi: " << currentTopicSelection.toStdString());
    } else {
        topicFilterComboBox->setCurrentText("T√ºm√º");
        LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Onceki konu secimi listede bulunamadi, 'Tumu' secildi.");
    }

    topicFilterComboBox->blockSignals(false); // Sinyalleri tekrar etkinle≈ütir

    // Mevcut filtrelerle listeyi yeniden doldur
    filterAndDisplayCapsules(searchLineEdit->text(),
    topicFilterComboBox->currentText(),
    startDateEdit->date(), endDateEdit->date(),
    specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi

    // Se√ßimi geri y√ºkle
    if (!selectedCapsuleId.isEmpty()) {
        QListWidgetItem *itemToSelect = nullptr;
        for (int i = 0; i < capsuleListWidget->count(); ++i) {
            QListWidgetItem *item = capsuleListWidget->item(i);
            if (item->data(Qt::UserRole).toString() == selectedCapsuleId) {
                itemToSelect = item;
                break;
            }
        }
        if (itemToSelect) {
            capsuleListWidget->setCurrentItem(itemToSelect);
            LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Secim geri yuklendi. ID: " << selectedCapsuleId.toStdString());
        } else {
            capsuleDetailDisplay->clear();
            LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Onceki secili kapsul listede bulunamadi, detaylar temizlendi.");
        }
    } else {
        capsuleDetailDisplay->clear();
    }

    LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: KnowledgeBase i√ßeriƒüi g√ºncellendi. Toplam kaps√ºl: " << currentDisplayedCapsules.size());
}

void KnowledgeBasePanel::onSelectedCapsuleChanged(QListWidgetItem* current, QListWidgetItem* previous) {
    Q_UNUSED(previous);
    if (!current) {
        capsuleDetailDisplay->clear();
        updateSuggestionFeedbackButtons(""); // ‚úÖ Se√ßim yoksa butonlarƒ± pasif yap
        return;
    }

    QString selectedCapsuleId = current->data(Qt::UserRole).toString();
    auto it = displayedCapsuleDetails.find(selectedCapsuleId);
    if (it != displayedCapsuleDetails.end()) {
        displayCapsuleDetails(it->second);
        LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: Kaps√ºl detaylarƒ± g√∂sterildi. ID: " << selectedCapsuleId.toStdString());
    } else {
        updateSuggestionFeedbackButtons("");
        capsuleDetailDisplay->setText("Detaylar bulunamadƒ±.");
        LOG_DEFAULT(CerebrumLux::LogLevel::WARNING, "KnowledgeBasePanel: Se√ßilen kaps√ºl ID'si dahili listeye uymuyor: " << selectedCapsuleId.toStdString());
    }
}

void KnowledgeBasePanel::onSearchTextChanged(const QString& text) {
    filterAndDisplayCapsules(text,
                             topicFilterComboBox->currentText(),
                             startDateEdit->date(),
                             endDateEdit->date(),
                             specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi
}

void KnowledgeBasePanel::onClearSearchClicked() {
    searchLineEdit->clear();
    filterAndDisplayCapsules(QString(),
                             topicFilterComboBox->currentText(),
                             startDateEdit->date(),
                             endDateEdit->date(),
                             specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi
}

// YENƒ∞ SLOTLARIN ƒ∞MPLEMENTASYONLARI
void KnowledgeBasePanel::onTopicFilterChanged(const QString& topic) {
    filterAndDisplayCapsules(searchLineEdit->text(),
                             topic,
                             startDateEdit->date(),
                             endDateEdit->date(),
                             specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi
}

// ‚úÖ YENƒ∞ SLOT: CodeDevelopment filtre kontrol√º i√ßin
void KnowledgeBasePanel::onSpecialFilterChanged(const QString& filter) {
    filterAndDisplayCapsules(searchLineEdit->text(),
                             topicFilterComboBox->currentText(),
                             startDateEdit->date(),
                             endDateEdit->date(),
                             filter); // Yeni filtre parametresi kullanƒ±ldƒ±
}

void KnowledgeBasePanel::onStartDateChanged(const QDate& date) {
    filterAndDisplayCapsules(searchLineEdit->text(),
                             topicFilterComboBox->currentText(),
                             date,
                             endDateEdit->date(),
                             specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi
}

void KnowledgeBasePanel::onEndDateChanged(const QDate& date) {
    filterAndDisplayCapsules(searchLineEdit->text(),
                             topicFilterComboBox->currentText(),
                             startDateEdit->date(),
                             date,
                             specialFilterComboBox->currentText()); // Yeni filtre parametresi eklendi
}

void KnowledgeBasePanel::filterAndDisplayCapsules(const QString& filterText,
                                                  const QString& topicFilter,
                                                  const QDate& startDate,
                                                  const QDate& endDate,
                                                  const QString& specialFilter) { // ‚úÖ Yeni parametre
    capsuleListWidget->clear();
    displayedCapsuleDetails.clear();

    LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: Kaps√ºl filtreleme baslatildi. Toplam kaps√ºl: " << currentDisplayedCapsules.size() << ", √ñzel Filtre: '" << specialFilter.toStdString() << "'");

    for (const auto& capsule : currentDisplayedCapsules) {        
        QString capsuleId = QString::fromStdString(capsule.id);
        QString topic = QString::fromStdString(capsule.topic);
        QString capsuleSource = QString::fromStdString(capsule.source);
        QString capsuleSummary = QString::fromStdString(capsule.plain_text_summary);
        // ‚úÖ D√úZELTME: Nanosaniyeden saniyeye d√∂n√º≈üt√ºrme yapƒ±ldƒ±
        if (capsule.timestamp_utc.time_since_epoch().count() == 0) { // Zaman damgasƒ± 0 ise varsayƒ±lan tarih ayarla (hata √∂nleme)
             // LOG_DEFAULT(CerebrumLux::LogLevel::WARNING, "KnowledgeBasePanel: Kaps√ºl ID'si " << capsuleId.toStdString() << " icin gecersiz zaman damgasi (0) tespit edildi. Varsayilan tarih kullanilacak."); // A≈üƒ±rƒ± loglamayƒ± engellemek i√ßin yorum satƒ±rƒ± yapƒ±ldƒ±
        }
        // Unix Epoch'tan itibaren nanosaniyeleri saniyeye √ßeviriyoruz.
        // std::chrono::system_clock::time_point nanosecond bazlƒ± olabilir, QDateTime::fromSecsSinceEpoch saniye bekler.
        auto epoch_nanos = capsule.timestamp_utc.time_since_epoch();
        auto epoch_secs = std::chrono::duration_cast<std::chrono::seconds>(epoch_nanos);
        QDateTime dt = QDateTime::fromSecsSinceEpoch(epoch_secs.count()); 
        QDate capsuleDate = dt.date();


        // ‚úÖ √ñzel filtre: yalnƒ±zca CodeDevelopment kaps√ºlleri
        if (specialFilter == "Sadece Code Development" && topic != "CodeDevelopment") {
            // LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Kaps√ºl √∂zel filtreden ge√ßmedi (Code Development deƒüil). ID: " << capsuleId.toStdString()); // Artik bu log seviyesi trace, genelde g√∂r√ºnmez.
            continue; // CodeDevelopment deƒüilse atla
        }
        // ‚úÖ TE≈ûHƒ∞S: Filtreleme ko≈üullarƒ±nƒ± ayrƒ± ayrƒ± deƒüerlendir
        bool matchesSearch = (filterText.isEmpty() ||
                              capsuleId.contains(filterText, Qt::CaseInsensitive) ||
                              topic.contains(filterText, Qt::CaseInsensitive) ||
                              capsuleSource.contains(filterText, Qt::CaseInsensitive) ||
                              capsuleSummary.contains(filterText, Qt::CaseInsensitive) ||
                              QString::fromStdString(capsule.code_file_path).contains(filterText, Qt::CaseInsensitive)); // code_file_path de aramaya dahil edildi

        bool matchesTopic = (topicFilter == "T√ºm√º" || topic.compare(topicFilter, Qt::CaseInsensitive) == 0);
        bool matchesStartDate = (!startDate.isValid() || capsuleDate >= startDate);
        bool matchesEndDate = (!endDate.isValid() || capsuleDate <= endDate);

        bool matches = matchesSearch && matchesTopic && matchesStartDate && matchesEndDate;
        if (!matches) {
            // LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Kaps√ºl diƒüer filtrelerden ge√ßmedi. ID: " << capsuleId.toStdString() // Artik bu log seviyesi trace, genelde g√∂r√ºnmez.
            //          << " (Arama: " << (matchesSearch ? "Gecti" : "Kaldi")
            //          << ", Konu: " << (matchesTopic ? "Gecti" : "Kaldi")
            //          << ", Baslangic Tarihi: " << (matchesStartDate ? "Gecti" : "Kaldi")
            //          << ", Bitis Tarihi: " << (matchesEndDate ? "Gecti" : "Kaldi")
            //          << ", Kaps√ºl Tarihi: " << capsuleDate.toString("dd.MM.yyyy").toStdString()
            //          << ", Filtre Baslangic: " << startDate.toString("dd.MM.yyyy").toStdString()
            //          << ", Filtre Bitis: " << endDate.toString("dd.MM.yyyy").toStdString() << ")");           
             continue;
        }
        //LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: Kaps√ºl t√ºm filtrelerden gecti ve listeye ekleniyor. ID: " << capsuleId.toStdString()); // Daha genel bir log

        QString itemText = QString("ID: %1 | Konu: %2 | Kaynak: %3 | Tarih: %4 | Dosya: %5")
                             .arg(capsuleId)
                             .arg(topic)
                             .arg(capsuleSource)
                             .arg(dt.toString("dd.MM.yyyy hh:mm"))
                             .arg(QString::fromStdString(capsule.code_file_path)); // ‚úÖ EKLENDƒ∞: code_file_path itemText'e eklendi
        
        QListWidgetItem *item = new QListWidgetItem(itemText);
        item->setData(Qt::UserRole, capsuleId);
        capsuleListWidget->addItem(item);

        KnowledgeCapsuleDisplayData data; // Yeni data objesi olusturuldu
        data.id = capsuleId;
        data.topic = topic;
        data.source = capsuleSource;
        data.summary = capsuleSummary;
        data.fullContent = QString::fromStdString(capsule.content);
        data.cryptofigBlob = QString::fromStdString(capsule.cryptofig_blob_base64);
        data.confidence = capsule.confidence;
        data.code_file_path = QString::fromStdString(capsule.code_file_path); 
        displayedCapsuleDetails[capsuleId] = data; // Data objesi mapa eklendi

        LOG_DEFAULT(CerebrumLux::LogLevel::TRACE, "KnowledgeBasePanel: Kaps√ºl QListWidget'a eklendi. ID: " << capsuleId.toStdString()); // Log seviyesi Trace'e d√º≈ü√ºr√ºld√º
    } // for d√∂ng√ºs√º burada bitiyor
    LOG_DEFAULT(CerebrumLux::LogLevel::DEBUG, "KnowledgeBasePanel: filterAndDisplayCapsules tamamlandi. Toplam listelenen kaps√ºl: " << capsuleListWidget->count());
}

void KnowledgeBasePanel::displayCapsuleDetails(const KnowledgeCapsuleDisplayData& data) {
    QString details;
    details += "<h3>Kaps√ºl Detaylarƒ±</h3>";
    details += "<b>ID:</b> " + data.id + "<br>";
    details += "<b>Konu:</b> " + data.topic + "<br>";
    details += "<b>Kaynak:</b> " + data.source + "<br>";
    details += "<b>G√ºven Seviyesi:</b> " + QString::number(data.confidence, 'f', 2) + "<br>";
    details += "<b>√ñzet:</b> " + data.summary + "<br>";
    details += "<b>Cryptofig (Base64):</b> " + data.cryptofigBlob.left(100) + "...<br>";
    // Daha √∂nce vardƒ±, ≈üimdi d√ºzg√ºn atama ile beraber √ßalƒ±≈ümalƒ±
    // Eski satƒ±r: details += "<b>Dosya Yolu:</b> " + data.codeFilePath + "<br>";
    if (!data.code_file_path.isEmpty()) { 
        details += "<b>Dosya Yolu:</b> " + data.code_file_path + "<br>";
    }
    details += "<br><b>Tam ƒ∞√ßerik:</b><br><pre>" + data.fullContent + "</pre>"; // Moved out of if block

    capsuleDetailDisplay->setHtml(details);
    updateSuggestionFeedbackButtons(data.id);
}

void KnowledgeBasePanel::updateSuggestionFeedbackButtons(const QString& selectedId) {
    bool enable = false;
    if (!selectedId.isEmpty()) {
        auto it = displayedCapsuleDetails.find(selectedId);
        if (it != displayedCapsuleDetails.end()) {
            if (it->second.topic == "CodeDevelopment") // Sadece CodeDevelopment kaps√ºlleri i√ßin aktif et
                enable = true;
        }
    }
    acceptSuggestionButton->setEnabled(enable);
    rejectSuggestionButton->setEnabled(enable);
}

void KnowledgeBasePanel::onAcceptSuggestionClicked() {
    if (!capsuleListWidget->currentItem()) return;
    QString id = capsuleListWidget->currentItem()->data(Qt::UserRole).toString();
    LOG_DEFAULT(CerebrumLux::LogLevel::INFO, "KnowledgeBasePanel: Kod Geli≈ütirme √ñnerisi KABUL EDƒ∞LDƒ∞. ID: " << id.toStdString());
    // LearningModule'e geri bildirim g√∂nder
    learningModule.processCodeSuggestionFeedback(id.toStdString(), true);
    QMessageBox::information(this, "√ñneri Kabul", "Kod geli≈ütirme √∂nerisi kabul edildi: " + id);
    updateKnowledgeBaseContent();
}

void KnowledgeBasePanel::onRejectSuggestionClicked() {
    if (!capsuleListWidget->currentItem()) return;
    QString id = capsuleListWidget->currentItem()->data(Qt::UserRole).toString();
    LOG_DEFAULT(CerebrumLux::LogLevel::INFO, "KnowledgeBasePanel: Kod Geli≈ütirme √ñnerisi REDDEDƒ∞LDƒ∞. ID: " << id.toStdString());
    // LearningModule'e geri bildirim g√∂nder
    learningModule.processCodeSuggestionFeedback(id.toStdString(), false);
    QMessageBox::information(this, "√ñneri Reddedildi", "Kod geli≈ütirme √∂nerisi reddedildi: " + id);
    updateKnowledgeBaseContent();
}

} // namespace CerebrumLux